---
// Products List Page with JSON-LD Schema
import BaseLayout from '../layouts/BaseLayout.astro';
import { generateProductListSchema } from '../util/productSchema';
import { fetchAllProducts } from '../lib/fetchProducts';

const products = await fetchAllProducts();
const siteUrl = Astro.site?.toString() || 'https://example.com';

// Generate JSON-LD for product list
const productListSchema = generateProductListSchema(
  products.map(p => ({
    title: p.title,
    description: p.description,
    price: p.price,
    currency: p.currency,
    image_url: p.image_url,
    availability: p.availability,
    condition: p.condition,
    link: p.link || `${siteUrl}/products/${p.id}`,
    brand: p.brand,
    gtin: p.gtin,
    mpn: p.mpn
  })),
  siteUrl
);

// Group products by availability
const availableProducts = products.filter(p => p.availability === 'in_stock');
const unavailableProducts = products.filter(p => p.availability !== 'in_stock');
---

<BaseLayout
  title="جميع المنتجات"
  description="تصفح جميع المنتجات والإعلانات المتاحة"
>
  <!-- JSON-LD Schema -->
  <script type="application/ld+json" set:html={productListSchema}></script>

  <main class="container mx-auto px-4 py-8">
    <h1 class="text-4xl font-bold mb-8 text-center">جميع المنتجات</h1>

    {availableProducts.length > 0 && (
      <section class="mb-12">
        <h2 class="text-2xl font-bold mb-6 text-green-600">المنتجات المتوفرة ({availableProducts.length})</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
          {availableProducts.map((product) => (
            <a
              href={`/products/${product.id}`}
              class="bg-white rounded-lg shadow-lg overflow-hidden hover:shadow-xl transition-shadow"
            >
              {product.image_url ? (
                <img
                  src={product.image_url}
                  alt={product.title}
                  class="w-full h-48 object-cover"
                  loading="lazy"
                />
              ) : (
                <div class="w-full h-48 bg-gray-200 flex items-center justify-center">
                  <span class="text-gray-400">لا توجد صورة</span>
                </div>
              )}
              
              <div class="p-4">
                <h3 class="font-bold text-lg mb-2 line-clamp-2">{product.title}</h3>
                
                {product.brand && (
                  <span class="text-sm text-gray-600 mb-2 block">{product.brand}</span>
                )}
                
                {product.price && (
                  <p class="text-green-600 font-bold text-xl mb-2">
                    {product.price} {product.currency}
                  </p>
                )}
                
                <p class="text-gray-600 text-sm line-clamp-2 mb-3">
                  {product.description || 'لا يوجد وصف'}
                </p>
                
                <div class="flex justify-between items-center">
                  <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">
                    متوفر
                  </span>
                  <span class="text-xs text-gray-500">
                    {product.condition === 'new' ? 'جديد' : product.condition === 'used' ? 'مستعمل' : 'مجدد'}
                  </span>
                </div>
              </div>
            </a>
          ))}
        </div>
      </section>
    )}

    {unavailableProducts.length > 0 && (
      <section>
        <h2 class="text-2xl font-bold mb-6 text-gray-600">منتجات غير متوفرة حالياً ({unavailableProducts.length})</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
          {unavailableProducts.map((product) => (
            <a
              href={`/products/${product.id}`}
              class="bg-white rounded-lg shadow-lg overflow-hidden hover:shadow-xl transition-shadow opacity-75"
            >
              {product.image_url ? (
                <img
                  src={product.image_url}
                  alt={product.title}
                  class="w-full h-48 object-cover grayscale"
                  loading="lazy"
                />
              ) : (
                <div class="w-full h-48 bg-gray-200 flex items-center justify-center">
                  <span class="text-gray-400">لا توجد صورة</span>
                </div>
              )}
              
              <div class="p-4">
                <h3 class="font-bold text-lg mb-2 line-clamp-2">{product.title}</h3>
                
                {product.brand && (
                  <span class="text-sm text-gray-600 mb-2 block">{product.brand}</span>
                )}
                
                {product.price && (
                  <p class="text-gray-600 font-bold text-xl mb-2">
                    {product.price} {product.currency}
                  </p>
                )}
                
                <p class="text-gray-600 text-sm line-clamp-2 mb-3">
                  {product.description || 'لا يوجد وصف'}
                </p>
                
                <div class="flex justify-between items-center">
                  <span class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded">
                    غير متوفر
                  </span>
                  <span class="text-xs text-gray-500">
                    {product.condition === 'new' ? 'جديد' : product.condition === 'used' ? 'مستعمل' : 'مجدد'}
                  </span>
                </div>
              </div>
            </a>
          ))}
        </div>
      </section>
    )}

    {products.length === 0 && (
      <div class="text-center py-12">
        <p class="text-gray-500 text-xl">لا توجد منتجات حالياً</p>
      </div>
    )}
  </main>
</BaseLayout>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
