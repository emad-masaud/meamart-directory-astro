---
import Listing from "@layouts/Listing.astro";
import { render, getEntry } from "astro:content";
import Landing from "@layouts/Landing.astro";
import { getRootPages } from "@lib/getRootPages";
import type { AllContent } from "../types/content";

export const prerender = true;

// Fetch all listings and pages
const { slug } = Astro.params;

// Get the entry from the collection
let entry: AllContent | undefined = Astro.props.entry;

// If no entry in props (SSR mode), fetch from collection
if (!entry && slug) {
  // Try pages collection first
  entry = await getEntry("pages", slug);
  
  // If not found in pages, try directory
  if (!entry) {
    entry = await getEntry("directory", slug);
  }
}

if (!entry) {
  return Astro.redirect("/404");
}

const { Content } = await render(entry);

export async function getStaticPaths() {
  return await getRootPages();
}

const landingView = !slug || slug === "blog" || slug === "categories" || slug === "about";
---

{
  landingView ? (
    <Landing>
      <Content />
    </Landing>
  ) : (
    <Listing frontmatter={entry.data} slug={slug}>
      <Content />
    </Listing>
  )
}
