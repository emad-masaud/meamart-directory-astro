---
import { getCollection } from "astro:content";
import BaseLayout from "@layouts/BaseLayout.astro";
import AppShell from "@components/app/AppShell.astro";
import { Icon } from "astro-icon/components";
import UserListingsDisplay from "@components/listings/UserListingsDisplay.vue";

const { username } = Astro.params;

// Get the user from collection
const users = await getCollection("users");
const user = users.find((u) => u.data.username === username);

if (!user) {
  return Astro.redirect("/404");
}

const {
  displayName,
  bio,
  city,
  country,
  phoneNumber,
  whatsappNumber,
  website,
  avatar,
  social,
  meachat,
  googleSheet,
  googleMerchant,
} = user.data;

export async function getStaticPaths() {
  const users = await getCollection("users");
  return users.map((user) => ({
    params: { username: user.data.username },
    props: { user },
  }));
}
---

<BaseLayout title={displayName} description={bio || `متجر ${displayName}`}>
  <AppShell>
    <div class="mx-auto max-w-4xl px-6 py-12">
      <!-- Profile Header -->
      <div class="mb-12 rounded-lg border border-gray-200 bg-white p-8 shadow-sm dark:border-gray-800 dark:bg-gray-900">
        <div class="flex flex-col items-start gap-8 sm:flex-row">
          <!-- Avatar -->
          {avatar && (
            <div class="flex-shrink-0">
              <img
                src={avatar}
                alt={displayName}
                class="h-32 w-32 rounded-full object-cover shadow-md"
              />
            </div>
          )}

          <!-- Info -->
          <div class="flex-1">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-gray-50">
              @{username}
            </h1>
            <p class="mt-1 text-lg font-semibold text-gray-700 dark:text-gray-300">
              {displayName}
            </p>

            {bio && <p class="mt-3 text-gray-600 dark:text-gray-400">{bio}</p>}

            <!-- Location & Contact -->
            <div class="mt-4 flex flex-wrap gap-4 text-sm text-gray-600 dark:text-gray-400">
              {city && (
                <div class="flex items-center gap-2">
                  <Icon name="tabler:map-pin" class="h-4 w-4" />
                  <span>
                    {city}, {country}
                  </span>
                </div>
              )}

              {phoneNumber && (
                <div class="flex items-center gap-2">
                  <Icon name="tabler:phone" class="h-4 w-4" />
                  <a href={`tel:${phoneNumber}`} class="hover:underline">
                    {phoneNumber}
                  </a>
                </div>
              )}

              {website && (
                <div class="flex items-center gap-2">
                  <Icon name="tabler:world" class="h-4 w-4" />
                  <a href={website} target="_blank" rel="noopener" class="hover:underline">
                    الموقع
                  </a>
                </div>
              )}
            </div>

            <!-- Action Buttons -->
            <div class="mt-6 flex flex-wrap gap-3">
              {whatsappNumber && (
                <a
                  href={`https://wa.me/${String(whatsappNumber).replace(/\D/g, "")}?text=السلام عليكم، أتواصل معكم بخصوص الإعلانات`}
                  target="_blank"
                  rel="noopener"
                  class="inline-flex items-center gap-2 rounded-md bg-green-600 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-green-700"
                >
                  <Icon name="tabler:brand-whatsapp" class="h-5 w-5" />
                  تواصل عبر WhatsApp
                </a>
              )}

              {meachat?.enabled && (
                <div class="inline-flex items-center gap-2 rounded-md bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow">
                  <Icon name="tabler:check" class="h-5 w-5" />
                  متصل مع MeaChat
                </div>
              )}

              {googleMerchant?.enabled && (
                <div class="inline-flex items-center gap-2 rounded-md bg-orange-600 px-4 py-2 text-sm font-semibold text-white shadow">
                  <Icon name="tabler:check" class="h-5 w-5" />
                  Google Merchant
                </div>
              )}

              {googleSheet?.enabled && (
                <div class="inline-flex items-center gap-2 rounded-md bg-blue-500 px-4 py-2 text-sm font-semibold text-white shadow">
                  <Icon name="tabler:sheet" class="h-5 w-5" />
                  Google Sheets
                </div>
              )}
            </div>
          </div>
        </div>

        <!-- Social Links -->
        {social && (social.instagram || social.twitter || social.facebook) && (
          <div class="mt-6 border-t border-gray-200 pt-6 dark:border-gray-800">
            <p class="mb-3 text-sm font-medium text-gray-700 dark:text-gray-300">تابعنا:</p>
            <div class="flex gap-3">
              {social.instagram && (
                <a href={social.instagram} target="_blank" rel="noopener" class="text-gray-500 hover:text-pink-600">
                  <Icon name="tabler:brand-instagram" class="h-6 w-6" />
                </a>
              )}
              {social.twitter && (
                <a href={social.twitter} target="_blank" rel="noopener" class="text-gray-500 hover:text-blue-400">
                  <Icon name="tabler:brand-twitter" class="h-6 w-6" />
                </a>
              )}
              {social.facebook && (
                <a href={social.facebook} target="_blank" rel="noopener" class="text-gray-500 hover:text-blue-600">
                  <Icon name="tabler:brand-facebook" class="h-6 w-6" />
                </a>
              )}
            </div>
          </div>
        )}
      </div>

      <!-- Integration Status -->
      <div class="grid gap-6 sm:grid-cols-2">
        <!-- MeaChat Status -->
        <div class="rounded-lg border border-gray-200 bg-white p-6 shadow-sm dark:border-gray-800 dark:bg-gray-900">
          <h3 class="flex items-center gap-2 text-lg font-semibold text-gray-900 dark:text-gray-50">
            <Icon name="tabler:brand-whatsapp" class="h-5 w-5 text-green-600" />
            MeaChat Integration
          </h3>
          <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
            {meachat?.enabled
              ? "✓ متصل ومفعّل - يمكنك استقبال الطلبات عبر WhatsApp Business"
              : "قم بتوصيل حسابك على MeaChat لتفعيل الإعلانات المباشرة"}
          </p>
        </div>

        <!-- Google Merchant Status -->
        <div class="rounded-lg border border-gray-200 bg-white p-6 shadow-sm dark:border-gray-800 dark:bg-gray-900">
          <h3 class="flex items-center gap-2 text-lg font-semibold text-gray-900 dark:text-gray-50">
            <Icon name="tabler:brand-google" class="h-5 w-5 text-orange-600" />
            Google Merchant
          </h3>
          <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
            {googleMerchant?.enabled
              ? "✓ متصل - يتم تصدير الإعلانات تلقائياً"
              : "توصيل Google Merchant Center لنشر إعلاناتك في Google Shopping"}
          </p>
        </div>

        <!-- Google Sheets Status -->
        <div class="rounded-lg border border-gray-200 bg-white p-6 shadow-sm dark:border-gray-800 dark:bg-gray-900">
          <h3 class="flex items-center gap-2 text-lg font-semibold text-gray-900 dark:text-gray-50">
            <Icon name="tabler:sheet" class="h-5 w-5 text-blue-600" />
            Google Sheets
          </h3>
          <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
            {googleSheet?.enabled
              ? "✓ متصل - يتم مزامنة البيانات تلقائياً"
              : "ربط Google Sheet كمصدر بيانات للإعلانات"}
          </p>
        </div>

        <!-- Listings Count -->
        <div class="rounded-lg border border-gray-200 bg-white p-6 shadow-sm dark:border-gray-800 dark:bg-gray-900">
          <h3 class="flex items-center gap-2 text-lg font-semibold text-gray-900 dark:text-gray-50">
            <Icon name="tabler:list" class="h-5 w-5 text-purple-600" />
            الإعلانات
          </h3>
          <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
            جميع إعلاناتك مرئية هنا ومتاحة للبحث والفلترة
          </p>
        </div>
      </div>

      <!-- Listings Section -->
      <div class="mt-12">
        <h2 class="mb-6 text-2xl font-bold text-gray-900 dark:text-gray-50">الإعلانات النشطة</h2>
        <UserListingsDisplay client:load username={username} />
      </div>

      <!-- Settings Link -->
      <div class="mt-12 text-center">
        <a
          href={`/@${username}/settings`}
          class="inline-flex items-center gap-2 rounded-md bg-gray-100 px-4 py-2 text-sm font-semibold text-gray-900 hover:bg-gray-200 dark:bg-gray-800 dark:text-gray-50 dark:hover:bg-gray-700"
        >
          <Icon name="tabler:settings" class="h-4 w-4" />
          الإعدادات
        </a>
      </div>
    </div>
  </AppShell>
</BaseLayout>
