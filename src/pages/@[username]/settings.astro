---
import { getCollection } from "astro:content";
import BaseLayout from "@layouts/BaseLayout.astro";
import AppShell from "@components/app/AppShell.astro";
import { Icon } from "astro-icon/components";
import { useTranslations } from "@util/useTranslations";

const { username } = Astro.params;
const { t } = useTranslations(Astro.request);

// Get the user from collection
const users = await getCollection("users");
const user = users.find((u) => u.data.username === username);

if (!user) {
  return Astro.redirect("/404");
}

const userData = user.data;

export async function getStaticPaths() {
  const users = await getCollection("users");
  return users.map((user) => ({
    params: { username: user.data.username },
    props: { user },
  }));
}
---

<BaseLayout title={`${userData.displayName} - الإعدادات`}>
  <AppShell>
    <div class="mx-auto max-w-3xl px-6 py-12">
      <div class="mb-8">
        <a
          href={`/@${username}`}
          class="inline-flex items-center gap-2 text-sm text-gray-600 hover:text-gray-900 dark:text-gray-400 dark:hover:text-gray-50"
        >
          <Icon name="tabler:arrow-left" class="h-4 w-4" />
          العودة
        </a>
      </div>

      <h1 class="mb-2 text-3xl font-bold text-gray-900 dark:text-gray-50">الإعدادات</h1>
      <p class="mb-8 text-gray-600 dark:text-gray-400">إدارة حسابك والتكاملات</p>

      <!-- Tabs -->
      <div class="mb-8 flex gap-4 border-b border-gray-200 dark:border-gray-800">
        <button
          class="tab-button active border-b-2 border-primary-600 px-4 py-2 text-sm font-medium text-gray-900 dark:text-gray-50"
          data-tab="profile"
        >
          الملف الشخصي
        </button>
        <button
          class="tab-button border-b-2 border-transparent px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-900 dark:text-gray-400 dark:hover:text-gray-50"
          data-tab="integrations"
        >
          التكاملات
        </button>
        <button
          class="tab-button border-b-2 border-transparent px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-900 dark:text-gray-400 dark:hover:text-gray-50"
          data-tab="danger"
        >
          خطر
        </button>
      </div>

      <!-- Profile Tab -->
      <div id="profile" class="tab-content">
        <div class="space-y-6 rounded-lg border border-gray-200 bg-white p-6 shadow-sm dark:border-gray-800 dark:bg-gray-900">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">اسم المستخدم</label>
            <input
              type="text"
              disabled
              value={userData.username}
              class="mt-1 w-full rounded-md border border-gray-300 bg-gray-100 px-3 py-2 text-sm dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400"
            />
            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">لا يمكن تغيير اسم المستخدم</p>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">الاسم الكامل</label>
            <input
              type="text"
              value={userData.displayName}
              class="mt-1 w-full rounded-md border border-gray-300 px-3 py-2 text-sm dark:border-gray-700 dark:bg-gray-800 dark:text-gray-100"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">البريد الإلكتروني</label>
            <input
              type="email"
              value={userData.email}
              class="mt-1 w-full rounded-md border border-gray-300 px-3 py-2 text-sm dark:border-gray-700 dark:bg-gray-800 dark:text-gray-100"
            />
          </div>

          <div class="grid gap-4 sm:grid-cols-2">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">المدينة</label>
              <input
                type="text"
                value={userData.city}
                class="mt-1 w-full rounded-md border border-gray-300 px-3 py-2 text-sm dark:border-gray-700 dark:bg-gray-800 dark:text-gray-100"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">الدولة</label>
              <input
                type="text"
                value={userData.country}
                class="mt-1 w-full rounded-md border border-gray-300 px-3 py-2 text-sm dark:border-gray-700 dark:bg-gray-800 dark:text-gray-100"
              />
            </div>
          </div>

          <div class="grid gap-4 sm:grid-cols-2">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">رقم الهاتف</label>
              <input
                type="tel"
                value={userData.phoneNumber || ""}
                class="mt-1 w-full rounded-md border border-gray-300 px-3 py-2 text-sm dark:border-gray-700 dark:bg-gray-800 dark:text-gray-100"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">WhatsApp</label>
              <input
                type="tel"
                value={userData.whatsappNumber || ""}
                class="mt-1 w-full rounded-md border border-gray-300 px-3 py-2 text-sm dark:border-gray-700 dark:bg-gray-800 dark:text-gray-100"
              />
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">النبذة</label>
            <textarea
              rows="3"
              class="mt-1 w-full rounded-md border border-gray-300 px-3 py-2 text-sm dark:border-gray-700 dark:bg-gray-800 dark:text-gray-100"
            >
{userData.bio}
            </textarea>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">الموقع الإلكتروني</label>
            <input
              type="url"
              value={userData.website || ""}
              class="mt-1 w-full rounded-md border border-gray-300 px-3 py-2 text-sm dark:border-gray-700 dark:bg-gray-800 dark:text-gray-100"
            />
          </div>

          <div class="border-t border-gray-200 pt-4 dark:border-gray-800">
            <button
              class="inline-flex items-center gap-2 rounded-md bg-primary-600 px-4 py-2 text-sm font-semibold text-white hover:bg-primary-700"
            >
              <Icon name="tabler:check" class="h-4 w-4" />
              حفظ التغييرات
            </button>
            <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">
              ملاحظة: يتم التعديل على ملف JSON. تم حفظ جميع التغييرات تلقائياً.
            </p>
          </div>
        </div>
      </div>

      <!-- Integrations Tab -->
      <div id="integrations" class="tab-content hidden">
        <div class="space-y-6">
          <!-- MeaChat Integration -->
          <div class="rounded-lg border border-gray-200 bg-white p-6 shadow-sm dark:border-gray-800 dark:bg-gray-900">
            <div class="flex items-start justify-between">
              <div>
                <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-50">MeaChat</h3>
                <p class="mt-1 text-sm text-gray-600 dark:text-gray-400">
                  ربط حسابك على MeaChat للحصول على طلبات الزبائن مباشرة عبر WhatsApp
                </p>
              </div>
              <div
                class={`inline-flex items-center gap-2 rounded-full px-3 py-1 text-xs font-semibold ${
                  userData.meachat?.enabled
                    ? "bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200"
                    : "bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-200"
                }`}
              >
                {userData.meachat?.enabled ? "متصل" : "غير متصل"}
              </div>
            </div>

            <div class="mt-4 space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Business Account ID</label>
                <input
                  type="text"
                  placeholder="123456789"
                  value={userData.meachat?.businessAccountId || ""}
                  class="mt-1 w-full rounded-md border border-gray-300 px-3 py-2 text-sm dark:border-gray-700 dark:bg-gray-800 dark:text-gray-100"
                />
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Catalog ID</label>
                <input
                  type="text"
                  placeholder="987654321"
                  value={userData.meachat?.catalogId || ""}
                  class="mt-1 w-full rounded-md border border-gray-300 px-3 py-2 text-sm dark:border-gray-700 dark:bg-gray-800 dark:text-gray-100"
                />
              </div>

              <div>
                <label class="flex items-center gap-2">
                  <input type="checkbox" checked={userData.meachat?.enabled} class="h-4 w-4" />
                  <span class="text-sm text-gray-700 dark:text-gray-300">تفعيل التكامل</span>
                </label>
              </div>
            </div>
          </div>

          <!-- Google Sheet Integration -->
          <div class="rounded-lg border border-gray-200 bg-white p-6 shadow-sm dark:border-gray-800 dark:bg-gray-900">
            <div class="flex items-start justify-between">
              <div>
                <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-50">Google Sheets</h3>
                <p class="mt-1 text-sm text-gray-600 dark:text-gray-400">
                  ربط Google Sheet كمصدر بيانات للإعلانات. سيتم مزامنة البيانات تلقائياً.
                </p>
              </div>
              <div
                class={`inline-flex items-center gap-2 rounded-full px-3 py-1 text-xs font-semibold ${
                  userData.googleSheet?.enabled
                    ? "bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200"
                    : "bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-200"
                }`}
              >
                {userData.googleSheet?.enabled ? "متصل" : "غير متصل"}
              </div>
            </div>

            <div class="mt-4 space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Sheet ID</label>
                <input
                  type="text"
                  placeholder="1BxiMVs0XRA5nFMKUVPxAydmHlYNYiZS4CCXfAMt6CkU"
                  value={userData.googleSheet?.sheetId || ""}
                  class="mt-1 w-full rounded-md border border-gray-300 px-3 py-2 text-sm dark:border-gray-700 dark:bg-gray-800 dark:text-gray-100"
                />
                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                  ابحث عن Sheet ID في رابط Google Sheet (بعد /d و قبل /)
                </p>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">اسم الورقة</label>
                <input
                  type="text"
                  placeholder="Products"
                  value={userData.googleSheet?.sheetName || ""}
                  class="mt-1 w-full rounded-md border border-gray-300 px-3 py-2 text-sm dark:border-gray-700 dark:bg-gray-800 dark:text-gray-100"
                />
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">فترة المزامنة (بالثواني)</label>
                <input
                  type="number"
                  placeholder="3600"
                  value={userData.googleSheet?.syncInterval || 3600}
                  class="mt-1 w-full rounded-md border border-gray-300 px-3 py-2 text-sm dark:border-gray-700 dark:bg-gray-800 dark:text-gray-100"
                />
              </div>

              <div>
                <label class="flex items-center gap-2">
                  <input type="checkbox" checked={userData.googleSheet?.enabled} class="h-4 w-4" />
                  <span class="text-sm text-gray-700 dark:text-gray-300">تفعيل التكامل</span>
                </label>
              </div>
            </div>
          </div>

          <!-- Google Merchant Integration -->
          <div class="rounded-lg border border-gray-200 bg-white p-6 shadow-sm dark:border-gray-800 dark:bg-gray-900">
            <div class="flex items-start justify-between">
              <div>
                <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-50">Google Merchant Center</h3>
                <p class="mt-1 text-sm text-gray-600 dark:text-gray-400">
                  نشر إعلاناتك على Google Shopping و WhatsApp Catalog
                </p>
              </div>
              <div
                class={`inline-flex items-center gap-2 rounded-full px-3 py-1 text-xs font-semibold ${
                  userData.googleMerchant?.enabled
                    ? "bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200"
                    : "bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-200"
                }`}
              >
                {userData.googleMerchant?.enabled ? "متصل" : "غير متصل"}
              </div>
            </div>

            <div class="mt-4 space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Merchant ID</label>
                <input
                  type="text"
                  placeholder="123456789"
                  value={userData.googleMerchant?.merchantId || ""}
                  class="mt-1 w-full rounded-md border border-gray-300 px-3 py-2 text-sm dark:border-gray-700 dark:bg-gray-800 dark:text-gray-100"
                />
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">العملة</label>
                <input
                  type="text"
                  placeholder="SAR"
                  value={userData.googleMerchant?.currency || "USD"}
                  class="mt-1 w-full rounded-md border border-gray-300 px-3 py-2 text-sm dark:border-gray-700 dark:bg-gray-800 dark:text-gray-100"
                />
              </div>

              <div>
                <label class="flex items-center gap-2">
                  <input type="checkbox" checked={userData.googleMerchant?.autoSync} class="h-4 w-4" />
                  <span class="text-sm text-gray-700 dark:text-gray-300">المزامنة التلقائية</span>
                </label>
              </div>

              <div>
                <label class="flex items-center gap-2">
                  <input type="checkbox" checked={userData.googleMerchant?.enabled} class="h-4 w-4" />
                  <span class="text-sm text-gray-700 dark:text-gray-300">تفعيل التكامل</span>
                </label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Danger Tab -->
      <div id="danger" class="tab-content hidden">
        <div class="rounded-lg border border-red-200 bg-red-50 p-6 dark:border-red-900 dark:bg-red-950">
          <h3 class="text-lg font-semibold text-red-900 dark:text-red-200">منطقة الخطر</h3>
          <p class="mt-2 text-sm text-red-800 dark:text-red-300">
            هذه الإجراءات لا يمكن التراجع عنها.
          </p>

          <div class="mt-6 space-y-4">
            <div class="rounded-lg border border-red-200 bg-white p-4 dark:border-red-900 dark:bg-gray-900">
              <p class="text-sm text-gray-700 dark:text-gray-300">
                حذف جميع البيانات الشخصية والإعلانات
              </p>
              <button
                class="mt-3 rounded-md border border-red-600 px-4 py-2 text-sm font-semibold text-red-600 hover:bg-red-50 dark:hover:bg-red-950"
              >
                حذف الحساب
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </AppShell>
</BaseLayout>

<script>
  document.querySelectorAll(".tab-button").forEach((button) => {
    button.addEventListener("click", () => {
      const tabName = button.dataset.tab;

      // Hide all tabs
      document.querySelectorAll(".tab-content").forEach((tab) => {
        tab.classList.add("hidden");
      });

      // Remove active state from all buttons
      document.querySelectorAll(".tab-button").forEach((btn) => {
        btn.classList.remove("border-primary-600");
        btn.classList.add("border-transparent");
      });

      // Show selected tab
      document.getElementById(tabName)?.classList.remove("hidden");

      // Add active state to button
      button.classList.remove("border-transparent");
      button.classList.add("border-primary-600");
    });
  });
</script>
