---
import { Icon } from "astro-icon/components";
import { locales } from "@util/i18nConfig";
---

<div class="relative inline-block" id="language-selector">
  <button
    id="language-button"
    class="inline-flex items-center justify-center rounded-md p-2 text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-600 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-primary-500"
    aria-label="Select language"
    aria-expanded="false"
  >
    <Icon name="tabler:language" class="h-6 w-6" aria-hidden="true" />
  </button>

  <!-- Dropdown menu -->
  <div
    id="language-menu"
    class="hidden absolute right-0 z-10 mt-2 w-48 origin-top-right rounded-md bg-white dark:bg-gray-700 py-1 shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none"
    role="menu"
    aria-orientation="vertical"
  >
    {
      Object.entries(locales).map(([code, locale]) => (
        <button
          data-locale={code}
          class="locale-option block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600"
          role="menuitem"
        >
          <span class="flex items-center gap-2">
            <Icon name={`circle-flags:${code === 'ar' ? 'sa' : 'us'}`} class="h-5 w-5" />
            {locale.name}
          </span>
        </button>
      ))
    }
  </div>
</div>

<script>
  import { locale } from "@store";

  const button = document.getElementById("language-button");
  const menu = document.getElementById("language-menu");
  const options = document.querySelectorAll(".locale-option");

  // Toggle menu
  button?.addEventListener("click", () => {
    const isHidden = menu?.classList.contains("hidden");
    if (isHidden) {
      menu?.classList.remove("hidden");
      button?.setAttribute("aria-expanded", "true");
    } else {
      menu?.classList.add("hidden");
      button?.setAttribute("aria-expanded", "false");
    }
  });

  // Close menu when clicking outside
  document.addEventListener("click", (event) => {
    const selector = document.getElementById("language-selector");
    if (!selector?.contains(event.target as Node)) {
      menu?.classList.add("hidden");
      button?.setAttribute("aria-expanded", "false");
    }
  });

  // Handle language selection
  options.forEach((option) => {
    option.addEventListener("click", () => {
      const selectedLocale = option.getAttribute("data-locale");
      if (selectedLocale) {
        locale.set(selectedLocale);
        menu?.classList.add("hidden");
        button?.setAttribute("aria-expanded", "false");
        
        // Reload page to apply new language
        window.location.reload();
      }
    });
  });
</script>
