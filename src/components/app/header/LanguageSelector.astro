---
import { Icon } from "astro-icon/components";
import { getLocaleFromRequest } from "@util/useTranslations";

const currentLocale = getLocaleFromRequest(Astro.request);
---

<div transition:persist id="language-selector-container">
  <button
    id="language-toggle"
    class="flex justify-center items-center border border-gray-200 rounded-full w-8 h-8 text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-800 dark:border-gray-500 transition-all"
    aria-label="Toggle language"
  >
    <span class="sr-only">Toggle Language</span>
    <span id="lang-display" class="text-sm font-semibold">{currentLocale.toUpperCase()}</span>
  </button>
</div>

<script>
  const supportedLocales = ["en", "ar"];

  function getCurrentLocale() {
    // Get from path first
    const pathSegment = window.location.pathname.split("/").filter(Boolean)[0];
    if (pathSegment && supportedLocales.includes(pathSegment)) {
      return pathSegment;
    }

    // Get from cookie
    const match = document.cookie.match(/locale=([^;]+)/);
    if (match && supportedLocales.includes(match[1])) {
      return match[1];
    }

    return "en";
  }

  function updateLanguageDisplay() {
    const langDisplay = document.getElementById("lang-display");
    if (langDisplay) {
      const currentLang = getCurrentLocale();
      langDisplay.textContent = currentLang.toUpperCase();
    }
  }

  function setupLanguageToggle() {
    const button = document.getElementById("language-toggle");
    
    if (button && !button.__languageSetup) {
      button.__languageSetup = true;
      button.addEventListener("click", () => {
        const currentLocale = getCurrentLocale();
        const nextLocale = currentLocale === "en" ? "ar" : "en";

        // Set cookie
        const maxAge = 60 * 60 * 24 * 365;
        document.cookie = `locale=${nextLocale}; path=/; max-age=${maxAge}`;

        // Build new URL
        const url = new URL(window.location.href);
        const segments = url.pathname.split("/").filter(Boolean);
        const hasLocalePrefix = segments[0] && supportedLocales.includes(segments[0]);
        const rest = hasLocalePrefix ? segments.slice(1) : segments;

        const newPath = nextLocale === "en" 
          ? `/${rest.join("/")}`.replace(/\/$/, "") || "/"
          : `/${nextLocale}/${rest.join("/")}`.replace(/\/$/, "") || `/${nextLocale}`;
        
        url.pathname = newPath;
        url.searchParams.delete("lang");
        window.location.assign(url.toString());
      });
    }
  }

  function init() {
    updateLanguageDisplay();
    setupLanguageToggle();
  }

  // Run immediately
  init();

  // Also run on various lifecycle events
  document.addEventListener("DOMContentLoaded", init, { once: true });
  document.addEventListener("astro:after-swap", init);
  document.addEventListener("astro:page-load", init);
</script>
