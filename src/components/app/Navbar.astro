---
import { Icon } from "astro-icon/components";
import ColorSelector from "./header/ColorSelector.astro";
import LanguageSelector from "./header/LanguageSelector.astro";
import Logo from "./Logo.astro";
import config from "@util/themeConfig";
import { useTranslations } from "@util/useTranslations";
import { resolveI18nString } from "@util/resolveI18nString";

// Helper function to check if a route is active
const isActive = (path: string, currentPath: string | undefined) => {
  if (!currentPath) return false;
  return (
    currentPath.split("/")[1] === path.split("/")[1] || currentPath === path
  );
};

// Get the current path safely
const currentPath = new URL(Astro.request.url).pathname;
const { t } = useTranslations(Astro.request);

const getNavName = (name: string) => resolveI18nString(name, t) ?? name;
const actionButtonText = resolveI18nString(
  config?.header?.actionButton?.text,
  t,
);

// Trustpilot-style navigation links
const trustpilotLinks = [
  { name: "الرئيسية", href: "/", target: "" },
  { name: "الأعمال", href: "/#directory", target: "" },
  { name: "الفئات", href: "/categories", target: "" },
  { name: "من نحن", href: "/about", target: "" },
];
---

<nav
  class="sticky top-0 z-50 bg-white border-b border-gray-200 shadow-sm dark:bg-gray-700 dark:border-gray-600"
>
  <div class="mx-auto max-w-7xl px-2 sm:px-6 lg:px-8">
    <div class="relative flex h-16 justify-between">
      <!-- Mobile menu button -->
      <div class="absolute inset-y-0 start-0 flex items-center sm:hidden">
        <button
          id="mobile-menu-button"
          class="relative inline-flex items-center justify-center rounded-md p-2 text-gray-400 hover:bg-gray-100 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-primary-500"
          aria-label={t.common.openMainMenu}
        >
          <span class="sr-only">{t.common.openMainMenu}</span>
          <Icon
            id="mobile-menu-icon"
            name="tabler:baseline-density-medium"
            class="block h-6 w-6"
            aria-hidden="true"
          />
        </button>
      </div>

      <!-- Logo and desktop menu -->
      <div
        class="flex flex-1 items-center justify-center sm:items-stretch sm:justify-start"
      >
        <div class="flex flex-shrink-0 items-center">
          <Logo />
        </div>
        <div class="hidden sm:ms-6 sm:flex sm:gap-1">
          {
            trustpilotLinks.map((navItem) => (
              <a
                href={navItem.href}
                class={`inline-flex items-center rounded-lg px-4 py-2 text-sm font-medium transition ${
                  isActive(navItem.href, currentPath)
                    ? "bg-emerald-50 text-emerald-700 dark:bg-emerald-900 dark:text-emerald-300"
                    : "text-gray-700 hover:bg-gray-100 dark:text-gray-200 dark:hover:bg-gray-600"
                }`}
              >
                {navItem.name}
              </a>
            ))
          }
        </div>
      </div>

      <!-- Action button, language and color selector -->
      <div
        class="absolute inset-y-0 end-0 flex items-center pe-2 sm:static sm:inset-auto sm:ms-6 sm:pe-0"
      >
        <div
          class="flex gap-2 items-center md:order-2 space-x-3 md:space-x-0 rtl:space-x-reverse"
        >
          <LanguageSelector transition:persist class="hidden md:flex" />
          {
            config.header.navbar.colorModeSelector && (
              <ColorSelector transition:persist class="hidden md:flex" />
            )
          }
          <a
            href="https://a55f440a.meamart-dashboard.pages.dev/login.html"
            class="hidden rounded-lg border-2 border-gray-300 bg-transparent px-4 py-2 text-sm font-semibold text-gray-700 transition hover:border-emerald-500 hover:text-emerald-700 md:block dark:border-gray-500 dark:text-gray-200 dark:hover:border-emerald-500"
          >
            تسجيل الدخول
          </a>
          <a
            href="https://a55f440a.meamart-dashboard.pages.dev/signup.html"
            class="hidden rounded-lg bg-emerald-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-emerald-700 md:block dark:bg-emerald-700 dark:hover:bg-emerald-800"
          >
            سجّل عملك مجاناً
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Mobile menu -->
  <div id="mobile-menu" class="sm:hidden hidden">
    <div class="space-y-1 pb-4 pt-2">
      {
        config.header.navbar.links.map((item) => (
          <a
            href={item.href}
            class={`block border-s-4 py-2 ps-3 pe-4 text-base font-medium ${
              isActive(item.href, currentPath)
                ? "bg-primary-50 border-primary-500 text-primary-700"
                : "border-transparent text-gray-500 hover:bg-gray-50 hover:border-gray-300 hover:text-gray-700"
            }`}
          >
            {getNavName(item.name)}
            {item.target === "_blank" && <Icon name="tabler:external-link" />}
          </a>
        ))
      }
    </div>

    <div class="border-t border-gray-200 pb-3 pt-4">
      <div class="flex items-center px-4">
        <a
          href={config?.header.actionButton?.href}
          class="text-white bg-primary-700 hover:bg-primary-800 focus:ring-4 focus:outline-none focus:ring-primary-300 font-medium rounded-lg text-sm px-4 py-2 text-center dark:bg-primary-600 dark:hover:bg-primary-700 dark:focus:ring-primary-800"
        >
          {actionButtonText}
        </a>
      </div>
    </div>
  </div>
</nav>

<!-- JavaScript to handle mobile menu toggle -->
<script>
  const mobileMenuButton = document.getElementById("mobile-menu-button");
  const mobileMenu = document.getElementById("mobile-menu");
  const mobileMenuIcon = document.getElementById("mobile-menu-icon");

  if (mobileMenuButton && mobileMenu && mobileMenuIcon) {
    mobileMenuButton.addEventListener("click", () => {
      const isOpen = mobileMenu.classList.toggle("hidden");
      mobileMenuIcon.setAttribute(
        "name",
        isOpen ? "tabler:baseline-density-medium" : "tabler:x",
      );
    });
  }
</script>
