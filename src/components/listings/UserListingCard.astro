---
import { Icon } from "astro-icon/components";
import Image from "astro/components/Image.astro";

const { listing, username } = Astro.props;

const {
  id,
  title,
  description,
  price,
  currency,
  category,
  image_url,
  city,
  contact_name,
  phone_number,
  featured,
  brand,
  model,
  year,
  condition,
  color,
} = listing;

const detailsUrl = `/@${username}/listing/${id}`;
---

<div
  class={`overflow-hidden rounded-lg border shadow-sm transition-all hover:shadow-md ${
    featured
      ? "border-primary-300 bg-primary-50 dark:border-primary-900 dark:bg-primary-950"
      : "border-gray-200 bg-white dark:border-gray-800 dark:bg-gray-900"
  }`}
>
  <!-- Image -->
  <div class="relative h-48 overflow-hidden bg-gray-100 dark:bg-gray-800">
    {image_url ? (
      <img
        src={image_url}
        alt={title}
        class="h-full w-full object-cover"
      />
    ) : (
      <div class="flex h-full items-center justify-center">
        <Icon name="tabler:image-off" class="h-12 w-12 text-gray-400" />
      </div>
    )}

    {featured && (
      <div class="absolute top-2 right-2 flex items-center gap-1 rounded-full bg-primary-600 px-3 py-1 text-xs font-semibold text-white shadow">
        <Icon name="tabler:star-filled" class="h-4 w-4" />
        مميز
      </div>
    )}

    {condition && (
      <div class="absolute top-2 left-2 rounded-full bg-gray-900/70 px-3 py-1 text-xs font-semibold text-white">
        {condition === "new"
          ? "جديد"
          : condition === "used"
            ? "مستعمل"
            : condition}
      </div>
    )}
  </div>

  <!-- Content -->
  <div class="p-4">
    <div class="flex items-start justify-between gap-2">
      <div class="flex-1">
        <a href={detailsUrl} class="font-semibold text-gray-900 hover:text-primary-600 dark:text-gray-50">
          {title}
        </a>
        {(brand || model || year) && (
          <p class="text-xs text-gray-500 dark:text-gray-400">
            {[brand, model, year].filter(Boolean).join(" • ")}
          </p>
        )}
      </div>
    </div>

    {description && (
      <p class="mt-2 line-clamp-2 text-sm text-gray-600 dark:text-gray-400">
        {description}
      </p>
    )}

    <!-- Tags -->
    <div class="mt-3 flex flex-wrap gap-1">
      {category && (
        <span class="inline-flex items-center gap-1 rounded-full bg-blue-100 px-2 py-1 text-xs font-medium text-blue-800 dark:bg-blue-900 dark:text-blue-200">
          {category}
        </span>
      )}
      {color && (
        <span class="inline-flex items-center gap-1 rounded-full bg-gray-100 px-2 py-1 text-xs font-medium text-gray-800 dark:bg-gray-800 dark:text-gray-200">
          {color}
        </span>
      )}
    </div>

    <!-- Price & Location -->
    <div class="mt-4 border-t border-gray-200 pt-3 dark:border-gray-800">
      <div class="flex items-center justify-between">
        {price && (
          <div class="text-lg font-bold text-primary-600 dark:text-primary-400">
            {price}
            {currency && <span class="text-xs ml-1">{currency}</span>}
          </div>
        )}
        {city && (
          <div class="flex items-center gap-1 text-xs text-gray-500 dark:text-gray-400">
            <Icon name="tabler:map-pin" class="h-4 w-4" />
            {city}
          </div>
        )}
      </div>
    </div>

    <!-- Contact -->
    {phone_number && (
      <div class="mt-3 text-xs text-gray-600 dark:text-gray-400">
        <a
          href={`https://wa.me/${phone_number.replace(/\D/g, "")}?text=أتواصل معك بخصوص: ${encodeURIComponent(title)}`}
          target="_blank"
          rel="noopener"
          class="inline-flex items-center gap-1 text-green-600 hover:text-green-700 dark:text-green-400"
        >
          <Icon name="tabler:brand-whatsapp" class="h-4 w-4" />
          تواصل
        </a>
      </div>
    )}
  </div>
</div>
